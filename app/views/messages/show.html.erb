<%= turbo_frame_tag "message_detail" do %>
  <div class="h-full flex flex-col">
    <div class="flex-1 overflow-y-auto" data-controller="live-renderer"
         data-live-renderer-action-url-value="<%= live_component_actions_path %>"
         data-live-renderer-action-token-value="<%= MessageDetailComponent.live_action_token(@message) %>">
      <%= render MessageDetailComponent.new(message: @message) %>
    </div>

    <%# Reply section â€” outside live-renderer so form_with doesn't break JS template compilation %>
    <div class="px-6 py-4 border-t border-gray-200" data-controller="inline-reply">
      <button class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
        data-inline-reply-target="button"
        data-action="click->inline-reply#show">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 mr-1.5">
          <path stroke-linecap="round" stroke-linejoin="round" d="M9 15L3 9m0 0l6-6M3 9h12a6 6 0 010 12h-3" />
        </svg>
        Reply
      </button>

      <div data-inline-reply-target="form" class="hidden">
        <%= form_with url: messages_path, class: "space-y-3" do |f| %>
          <%= f.hidden_field :replied_to_id, value: @message.id %>
          <%= f.hidden_field :recipient_id, value: reply_recipient_id(@message) %>
          <%= f.hidden_field :subject, value: "Re: #{@message.thread_root.subject}" %>

          <div>
            <%= f.text_area :body,
              rows: 4,
              placeholder: "Write your reply...",
              class: "block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-blue-600 sm:text-sm sm:leading-6" %>
          </div>

          <div class="flex items-center justify-end">
            <%= f.submit "Send",
              class: "inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 cursor-pointer" %>
          </div>
        <% end %>
      </div>
    </div>
  </div>
<% end %>
